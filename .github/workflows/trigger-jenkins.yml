name: Trigger Jenkins Pipeline

on:
  issue_comment:
    types: [created]

jobs:
  trigger-jenkins:
    # Only run when someone comments /approve on a PR
    if: |
      github.event_name == 'issue_comment' && 
      github.event.issue.pull_request && 
      contains(github.event.comment.body, '/approve')
    
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.event.issue.pull_request.head.sha }}
      
      - name: Get PR details
        id: pr-details
        run: |
          echo "pr_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          PR_DATA=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.issue.number }}")
          PR_BRANCH=$(echo "$PR_DATA" | jq -r '.head.ref')
          PR_AUTHOR=$(echo "$PR_DATA" | jq -r '.user.login')
          BASE_BRANCH=$(echo "$PR_DATA" | jq -r '.base.ref')
          echo "pr_branch=$PR_BRANCH" >> $GITHUB_OUTPUT
          echo "pr_author=$PR_AUTHOR" >> $GITHUB_OUTPUT
          echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT
          echo "trigger_type=approve_comment" >> $GITHUB_OUTPUT
      
      - name: Trigger Jenkins Pipeline via Webhook
        # env:
        #   JENKINS_WEBHOOK_URL: ${{ secrets.JENKINS_WEBHOOK_URL }}
        run: |
          # Trigger Jenkins job via webhook with JSON payload
          curl -X POST \
            "https://unthriftily-unrenewable-charles.ngrok-free.dev/generic-webhook-trigger/invoke?token=test" \
            -H "Content-Type: application/json" \
            -d '{
              "repository_name": "${{ github.event.repository.name }}",
              "dst_branch": "${{ steps.pr-details.outputs.base_branch }}",
              "src_branch": "${{ steps.pr-details.outputs.pr_branch }}",
              "lastCommitId": "${{ github.sha }}"
            }'
      
      - name: Add status check
        if: success()
        run: |
          echo "Jenkins pipeline triggered successfully"
          echo "Repository: ${{ github.event.repository.name }}"
          echo "Source Branch (src_branch): ${{ steps.pr-details.outputs.pr_branch }}"
          echo "Destination Branch (dst_branch): ${{ steps.pr-details.outputs.base_branch }}"
          echo "Last Commit ID: ${{ github.sha }}"